{% extends "analyzer/base.html" %}

{% block title %}Risk Report â€” {{ contract.filename }}{% endblock %}

{% block content %}
<div class="results-wrapper">

  <div class="results-header">
    <div class="results-meta">ğŸ“„ {{ contract.filename }} &nbsp;â€¢&nbsp; {{ contract.created_at|date:"M d, Y H:i" }}</div>
    <h1 class="results-title">Contract Risk Report</h1>
    <p class="results-summary">{{ contract.summary }}</p>
    {% if party_info %}
    <div class="party-tags">
      {% if party_info.document_type %}<span class="tag">ğŸ“‹ {{ party_info.document_type }}</span>{% endif %}
      {% if party_info.key_parties %}<span class="tag">ğŸ‘¥ {{ party_info.key_parties }}</span>{% endif %}
    </div>
    {% endif %}
  </div>

  <div class="results-actions">
    <a href="/dashboard" class="btn btn-ghost">â† New Analysis</a>
    <a href="/history/" class="btn btn-ghost">ğŸ“‹ History</a>
  </div>


  <div class="score-grid">
    <div class="score-card--main">
      <div class="score-number score-{{ contract.overall_risk_level|lower }}">{{ contract.overall_risk_score }}</div>
      <div class="score-label">/ 100</div>
      <div class="score-sublabel">Risk Score</div>
      <span class="severity-badge sev-{{ contract.overall_risk_level|lower }}">{{ contract.overall_risk_level }} Risk</span>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number">{{ quick_stats.total_risks|default:0 }}</div>
        <div class="stat-label">Total Risks</div>
      </div>
      <div class="stat-card">
        <div class="stat-number text-critical">{{ quick_stats.critical_risks|default:0 }}</div>
        <div class="stat-label">Critical</div>
      </div>
      <div class="stat-card">
        <div class="stat-number text-high">{{ quick_stats.high_risks|default:0 }}</div>
        <div class="stat-label">High</div>
      </div>
      <div class="stat-card">
        <div class="stat-number text-medium">{{ missing_protections|length }}</div>
        <div class="stat-label">Missing</div>
      </div>
    </div>
  </div>


  <div class="results-chat-grid">

    <div class="results-col">

   
      <section class="results-section">
        <div class="section-header">
          <h2 class="section-title">âš ï¸ Identified Risks</h2>
          <span class="section-count">{{ risks|length }} found</span>
        </div>
        {% for risk in risks %}
        <div class="risk-card" id="risk-card-{{ risk.id }}">
          <div class="risk-card-header" onclick="toggleRisk(this)">
            <span class="severity-badge sev-{{ risk.severity|lower }}">{{ risk.severity }}</span>
            <div class="risk-card-info">
              <div class="risk-card-title">{{ risk.title }}</div>
              <div class="risk-card-category">{{ risk.category }}</div>
            </div>
            <span class="status-pill status-{{ risk.status }}">{{ risk.get_status_display }}</span>
            <span class="risk-toggle">â–¾</span>
          </div>
          <div class="risk-card-body">
            {% if risk.clause %}
            <blockquote class="risk-clause">"{{ risk.clause }}"</blockquote>
            {% endif %}
            <p class="risk-explanation">{{ risk.explanation }}</p>
            <div class="risk-rec"><strong>Recommendation</strong>{{ risk.recommendation }}</div>

           
            <div class="risk-review">
              <div class="review-label">Mark as:</div>
              <div class="review-actions">
                <button class="review-btn {% if risk.status == 'reviewed' %}active{% endif %}" onclick="updateRisk({{ risk.id }}, 'reviewed', this)">âœ“ Reviewed</button>
                <button class="review-btn {% if risk.status == 'accepted' %}active{% endif %}" onclick="updateRisk({{ risk.id }}, 'accepted', this)">âœ” Accepted</button>
                <button class="review-btn {% if risk.status == 'disputed' %}active{% endif %}" onclick="updateRisk({{ risk.id }}, 'disputed', this)">âœ— Disputed</button>
              </div>
              <textarea class="review-note" placeholder="Add a note..." onblur="saveNote({{ risk.id }}, this.value)">{{ risk.user_note }}</textarea>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="empty-state">âœ… No major risks identified.</div>
        {% endfor %}
      </section>

      
      <section class="results-section">
        <div class="section-header">
          <h2 class="section-title">ğŸ”’ Missing Protections</h2>
          <span class="section-count">{{ missing_protections|length }} found</span>
        </div>
        {% for item in missing_protections %}
        <div class="simple-card">
          <span class="simple-card-icon">ğŸ”¸</span>
          <div class="simple-card-body">
            <div class="simple-card-title">{{ item.title }} <span class="severity-badge sev-{{ item.importance|lower }} badge--sm">{{ item.importance }}</span></div>
            <p class="simple-card-desc">{{ item.explanation }}</p>
          </div>
        </div>
        {% empty %}
        <div class="empty-state">âœ… No missing protections identified.</div>
        {% endfor %}
      </section>

    
      <section class="results-section">
        <div class="section-header">
          <h2 class="section-title">âœ… Favorable Clauses</h2>
          <span class="section-count">{{ positive_clauses|length }} found</span>
        </div>
        {% for item in positive_clauses %}
        <div class="simple-card">
          <span class="simple-card-icon">âœ…</span>
          <div class="simple-card-body">
            <div class="simple-card-title">{{ item.title }}</div>
            <p class="simple-card-desc">{{ item.explanation }}</p>
          </div>
        </div>
        {% empty %}
        <div class="empty-state">No favorable clauses identified.</div>
        {% endfor %}
      </section>

    </div>

   
    <div class="chat-col">
      <div class="chat-panel">
        <div class="chat-header">
          <div class="chat-title">ğŸ’¬ Ask About This Contract</div>
          <div class="chat-sub">Ask anything about the risks, clauses, or your options</div>
        </div>
        <div class="chat-messages" id="chat-messages">
          <div class="chat-bubble assistant">
            ğŸ‘‹ Hi! I've analyzed your contract. Ask me anything â€” about specific clauses, what risks mean, how to negotiate, or anything else.
          </div>
        </div>
        <div class="chat-input-area">
          <textarea id="chat-input" placeholder="e.g. What does the indemnification clause mean?" rows="2" onkeydown="chatKeydown(event)"></textarea>
          <button class="btn btn-accent" onclick="sendChat()">Send â†‘</button>
        </div>
        <div class="chat-suggestions">
          <button class="suggestion" onclick="askSuggestion(this)">What's the biggest risk?</button>
          <button class="suggestion" onclick="askSuggestion(this)">Can I negotiate clause terms?</button>
          <button class="suggestion" onclick="askSuggestion(this)">Explain the termination clause</button>
        </div>
      </div>
    </div>

  </div>

  <div class="disclaimer">âš ï¸ ClauseGuard is an AI tool and does not constitute legal advice. Always consult a qualified lawyer.</div>

</div>
{% endblock %}

{% block extra_js %}
<script>
  window.CONTRACT_ID = {{ contract.id }};
</script>
{% endblock %}
